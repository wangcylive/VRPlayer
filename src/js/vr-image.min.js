!function(e){function t(){return"undefined"!=typeof TransitionEvent?"transitionend":"undefined"!=typeof WebKitTransitionEvent?"webkitTransitionEnd":void 0}function n(e){function t(e){return"-"+e.toLowerCase()}return e.indexOf("-")!==-1?e.toLowerCase():e.replace(/^[A-Z]/,function(e){return e.toLowerCase()}).replace(/^(webkit|moz|ms|o)/i,function(e){return"-"+e}).replace(/[A-Z]/g,t)}function i(e,t){return new i.fn.init(e,t)}var r=e(),o=window,a=document,s=(a.documentElement,a.body),c=r(o),l=r(s),u="1.2.0",f="active",h="vr-lock",d="is-fullscreen",m="is-ready",v="is-stereo",p=["您的浏览器不支持全景图片","您的浏览器不支持陀螺仪","您的浏览器不支持全屏","图片资源不可用"],y=100,g=75,E=30,w=120,b=0,C=function(){var e=navigator.userAgent;return{mobile:/Mobile|Android|Symbian/i.test(e),android:/Android|Adr/i.test(e),ios:/iPhone|iPad|iPod/i.test(e),symbian:/Symbian/i.test(e),windowsPhone:/Windows Phone/i.test(e),blankBerry:/BB/i.test(e),weChat:/MicroMessenger/i.test(e),qq:/MQQBrowser/i.test(e),uc:/UCBrowser/i.test(e),chrome:/Chrome\/[\d\.]+ Mobile Safari\/[\d\.]+$/i.test(e),firefox:/Firefox/i.test(e),ie:/MSIE/i.test(e),ie11:/Trident\/7\.0/i.test(e),edge:/Edge/i.test(e)}}(),T=function(){for(var e,t=a.createElement("canvas"),n=["webgl","experimental-webgl"],i=0;i<n.length;i++)try{if(e=t.getContext(n[i]))break}catch(r){}return!!e}(),x=T;o.requestAnimationFrame=o.requestAnimationFrame||o.mozRequestAnimationFrame||o.webkitRequestAnimationFrame||o.msRequestAnimationFrame,o.cancelAnimationFrame=o.cancelAnimationFrame||o.mozCancelAnimationFrame,r.createElem=function(e,t){if("string"==typeof e&&(e=r.trim(e))){var n=a.createElement(e);return"string"==typeof t&&(t=r.trim(t))&&(n.className=t),r(n)}};var M=function(){var e,t=["","-webkit-","-moz-","-ms-","-o-"],i=a.createElement("div"),r=i.style;return function(i){i=n(i);for(var o=0,a=t.length;o<a;o++)if(e="",e=t[o]?t[o]+i:i,e in r)return e}}();(function(){return!("undefined"==typeof AnimationEvent&&"undefined"==typeof WebKitAnimationEvent)})(),function(){return!("undefined"==typeof TransitionEvent&&"undefined"==typeof WebKitTransitionEvent)}(),function(){var e=!1;try{var t=a.createEvent("TouchEvent");t.initEvent("touchstart"),e=!0}catch(n){}return e}();c.one("deviceorientation",function(e){b=null!==e.alpha,i.fn.supportOrientation=b,i.fn.testedOrientation=!0,"function"==typeof i.deviceorientation&&i.deviceorientation(b)});var F=function(){function e(e){r&&"function"==typeof e&&(a.addEventListener(r,e,!1),d.push(e))}function t(){d.forEach(function(e){a.removeEventListener(r,e,!1)})}function n(){l?"function"==typeof c&&c.call(s):console.info("unable fullscreen")}function i(){"function"==typeof u&&u.call(a)}var r,o,s=a.documentElement,c=s.requestFullscreen||s.webkitRequestFullScreen||s.mozRequestFullScreen||s.msRequestFullscreen,l=a.fullscreenEnabled||a.webkitFullscreenEnabled||a.mozFullScreenEnabled||a.msFullscreenEnabled||!0,u=a.exitFullscroll||a.webkitCancelFullScreen||a.mozCancelFullScreen||a.msExitFullscreen,f=["fullscreenchange","webkitfullscreenchange","mozfullscreenchange","MSFullscreenChange"],h=["fullscreenElement","webkitFullscreenElement","webkitCurrentFullScreenElement","mozFullScreenElement","msFullscreenElement"];f.some(function(e){if("on"+e in a)return r=e}),h.some(function(e){if(e in a)return o=e});var d=[];return{on:e,off:t,request:n,exit:i,fullscreenElement:o}}(),A=M("transition"),O=(M("transform"),t());i.jQuery=r,i.browser=C,i.fn=i.prototype={version:u,constructor:i,setSrc:function(e){var t=this.image;t&&t.attr("src",e)},destroy:function(){if("destroy"!==this.status){cancelAnimationFrame(this.vrRequestID),this.image.off();var e=this.main;F.exit(),c.off(),e.off().find(".ui-vr").off(),e.find(".stereo, .orientation, .exit-vr, .fullscreen").off(),F.off();var t=["image-vr",d,m,v];e.empty().removeClass(t.join(" ")),l.removeClass(h),delete this.image,this.status="destroy"}},fullscreen:function(){var e=this.main;return e&&(e.hasClass(d)?(F.exit(),l.removeClass(h),e.removeClass(d)):(F.request(),l.addClass(h),e.addClass(d))),this},toast:function(){function e(e){return i.text(e).show(),s=1,clearTimeout(n),n=setTimeout(function(){i.hide(),s=0},o)}function t(){s&&(clearTimeout(n),i.hide(),s=0)}var n,i=r("#vrToast"),o=4e3,s=0;return void 0===i[0]&&(i=r.createElem("div","vr-toast").attr("id","vrToast").hide(),l.append(i)),a.addEventListener("click",t,!0),a.addEventListener("touchend",t,!0),e}(),supportWebGL:T,supportVR:x,supportOrientation:b},i.fn.init=function(e,t){function n(e){e.wheelDeltaY?j.fov-=.05*e.wheelDeltaY:e.wheelDelta?j.fov-=.05*e.wheelDelta:e.detail&&(j.fov+=1*e.detail),j.fov=Math.min(w,Math.max(E,j.fov)),$.fov=j.fov,$.updateProjectionMatrix()}function i(){return $.aspect=e.clientWidth/e.clientHeight,$.updateProjectionMatrix(),Q.setSize(e.clientWidth,e.clientHeight),C.mobile&&C.uc&&(ee.needsUpdate=!0),Q.render(U,$),j}function o(t){ye=0,ge=e.clientWidth,Ee=e.clientHeight;var n=t.targetTouches,i=n[0];if(1===n.length&&void 0===ie&&(ce=1,ie=i.identifier,fe=le,he=ue,de=i.clientX,me=i.clientY),2===n.length){ce=0;var r=n[0],o=n[1],a=Math.abs(r.clientX-o.clientX),s=Math.abs(r.clientY-o.clientY);re=Math.sqrt(Math.pow(a,2)+Math.pow(s,2)),oe=$.fov}}function s(e){e.preventDefault(),ye=1;var t=e.targetTouches,n=e.changedTouches,i=n[0];if(ie===i.identifier&&ce&&(ve=de-i.clientX,pe=i.clientY-me,le=ve/Ee*1.5*j.fov/g+fe,ue=pe/Ee*1.5*j.fov/g+he),t.length>1){var r=t[0],o=t[1],a=Math.abs(r.clientX-o.clientX),s=Math.abs(r.clientY-o.clientY),c=Math.sqrt(Math.pow(a,2)+Math.pow(s,2))-re;j.fov=oe-.2*c,j.fov=Math.min(w,Math.max(E,j.fov)),$.fov=j.fov,$.updateProjectionMatrix()}}function u(e){var t=e.targetTouches,n=t[0],i=e.changedTouches,r=i[0];ie===r.identifier&&(ce=0,ie=void 0),1===t.length&&(ce=1,ie=n.identifier,fe=le,he=ue,de=n.clientX,me=n.clientY)}function T(t){ce=1,ye=0,fe=le,he=ue,de=t.clientX,me=t.clientY,ge=e.clientWidth,Ee=e.clientHeight}function M(e){e.preventDefault(),ye=1,ce&&(ve=de-e.clientX,pe=e.clientY-me,le=ve/Ee*1.5*j.fov/g+fe,ue=pe/Ee*1.5*j.fov/g+he)}function R(e){ce=0}function q(){clearTimeout(ae),se=0,V.show(),setTimeout(function(){V.css(A,"all .4s").css("opacity",1)},10),ae=setTimeout(function(){V.css(A,"all .6s").css("opacity",0),se=1},4e3)}function S(){return j.isVRView=1,Q=K,F.request(),b&&(ne.connect(),j.isOrientation=1),l.addClass(h),L.addClass(v),V.show(),clearTimeout(ae),ae=setTimeout(function(){V.css(A,"all .6s").css("opacity",0),se=1},3e3),L.on("click",q),i(),j}function H(){return j.isVRView=0,Q=G,ne.disconnect(),j.isOrientation=0,I.removeClass(f),F.exit(),l.removeClass(h),L.removeClass(v),clearTimeout(ae),V.hide(),L.off("click",q),B.removeClass(f),i(),j}function P(){return b?(j.isOrientation?(ne.disconnect(),I.removeClass(f)):(ne.connect(),I.addClass(f)),j.isOrientation=!j.isOrientation):j.toast(p[1]),j}if(!e||1!==e.nodeType)throw new TypeError("Failed to 'imageVR' arguments, 1 argument must be 'Element'");t="object"==typeof t?t:{};var k={};!function(){var e;for(e in t)t.hasOwnProperty(e)&&(k[e]=t[e])}();var j=this,L=r(e),N=r.createElem("div","ratio-vr"),z=r.createElem("div","ui-vr"),W=r.createElem("div","loading-vr"),D=r.createElem("div","message-vr"),V=r.createElem("div","exit-vr"),Y=r.createElem("div","controls-vr"),X=r.createElem("button","stereo"),B=r.createElem("button","fullscreen"),I=r.createElem("button","orientation");if(x){L.append(N),L.addClass("image-vr"),z.append(W.html('<i class="icon rotate"></i><span class="text">'+(k.loading||"加载中...")+"</span>")).append(D),L.append(z),isNaN(k.ratio)||N.css("padding-top",100*k.ratio+"%"),V.text("退出VR视角");var Q,U,$,G,K,Z,J,_,ee,te,ne,ie,re,oe,ae,se,ce=0,le=0,ue=0,fe=0,he=0,de=0,me=0,ve=0,pe=0,ye=!1,ge=e.clientWidth,Ee=e.clientHeight;V.on(O,function(){1===se&&(V.hide(),se=0)},!1);var we=r.createElem("img");we.attr("crossOrigin","anonymous"),j.image=we,j.main=r(e),j.fov=g,j.isVRView=0,j.isOrientation=0,Q=G=new THREE.WebGLRenderer,K=new THREE.StereoEffect(Q),$=new THREE.PerspectiveCamera(g,e.clientWidth/e.clientHeight,1,1e3),U=new THREE.Scene,ne=new THREE.DeviceOrientationControls($),we.on("change",function(){ee=new THREE.Texture(j.image[0]),ee.needsUpdate=!0}),we.on("load",function(){Y.append(X).append(B).append(I),L.append(Y).append(V).addClass(m);var e=this.width,t=this.height;e/t!==2&&console.warn("The image size does not conform to the panoramic display, will produce deformation."),ee=new THREE.Texture(j.image[0]),_=new THREE.MeshBasicMaterial({map:ee}),J=new THREE.SphereBufferGeometry(y,60,60),J.scale(-1,1,1),Z=new THREE.Mesh(J,_),U.add(Z),Q.render(U,$),c.on("resize",i),z.on("mousedown",T).on("touchstart",o).on("mousemove",M).on("touchmove",s),z.on("mouseup mouseout touchcancel",R).on("touchend",u),X.on("click",S),I.on("click",P),V.on("click",H),L.on("mousewheel MozMousePixelScroll",n),B.on("click",function(){j.fullscreen(),i()}),F.on(function(){a[F.fullscreenElement]!==a.documentElement&&(l.removeClass(h),L.removeClass(d),B.removeClass(f)),i()});var r=function(){ue=Math.max(-Math.PI/2,Math.min(Math.PI/2,ue));var e=y*Math.cos(le)*Math.cos(ue),t=y*Math.sin(ue),n=y*Math.sin(le)*Math.cos(ue),i=new THREE.Vector3(e,t,n);j.isOrientation?ne.update():$.lookAt(i),Q.render(U,$),j.vrRequestID=requestAnimationFrame(r)};r(),j.resize=i,j.requestStereo=S,j.exitStereo=H,j.changeOrientation=P}).on("load",function(){W.hide(),D.hide(),ee.needsUpdate=!0,"function"==typeof j.load&&j.load(event)}).on("error",function(){throw W.hide(),D.text(p[3]).show(),new Error("Image resource loaded errors.")}),t.src&&we.attr("src",k.src),Q.setSize(e.clientWidth,e.clientHeight),Q.setClearColor(6710886),Q.setPixelRatio(window.devicePixelRatio||1),te=Q.domElement,L.append(te)}},i.fn.init.prototype=i.prototype,"function"==typeof define&&define.amd?define(["three","three-extend"],function(){return i}):"object"==typeof exports?module.exports=i:window.imageVR=i}(function(){function e(e){return e.hasOwnProperty(c)||Object.defineProperty(e,c,{value:++l}),e[c]}function t(e,t){if(e.hasOwnProperty(c)){var n=e[c],i=u[t];if(i&&(i=i.filter(function(e){return e.guid===n}),i.length>0))return i}return[]}function n(e,t){var n=[];return t=t||{bubbles:!1,cancelable:!1,detail:null},"string"==typeof e&&(e=a.trim(e))&&(e=e.split(/\s+/),e.forEach(function(e){n.push(new CustomEvent(e,t))})),n}function i(e){var t=this;u[e.type]&&u[e.type].filter(function(e){return e.guid===t[c]}).forEach(function(n){if(null==n.selector)n.handler.call(t,e);else{var i=[];try{i=m.slice.call(t.querySelectorAll(n.selector),0)}catch(r){}for(var o=e.target;o!==t;)-1!==i.indexOf(o)&&n.handler.call(o,e),o=o.parentNode}})}function r(e,t){for(var n,i,r,s=0;s<e.length;s++)n=e[s],i=n.style,r=n.nodeName,t?(i.display="",a.isHidden(n)?f.hasOwnProperty(r)?i.display=f[r]:i.display=f[r]=o(n.nodeName):f[r]=a.css(n,"display")):a.isHidden(n)||(f[r]=a.css(n,"display"),i.display="none")}function o(e){var t=document.createElement(e);document.body.appendChild(t);var n=a.css(t,"display");return document.body.removeChild(t),n}var a=function(e){return new a.fn.init(e)},s="1.3.0",c="JQ"+(s+Math.random()+"").replace(/\D/g,""),l=0;a.expando=c,a.version=s;var u={},f={};!function(){function e(e,t){t=t||{bubbles:!1,cancelable:!1,detail:null};var n=document.createEvent("CustomEvent");return n.initCustomEvent(e,t.bubbles,t.cancelable,t.detail),n}return"function"!=typeof window.CustomEvent&&(e.prototype=window.Event.prototype,void(window.CustomEvent=e))}();var h=/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,d=Object.prototype.toString,m=Array.prototype;return a.css=function(e,t){if(e&&1===e.nodeType)return window.getComputedStyle(e,null)[t]},a.isHidden=function(e){return"none"===a.css(e,"display")},a.trim=function(e){return null==e?"":(e+"").replace(h,"")},a.isArray=function(e){return Array.isArray(e)},a.arrayFrom=function(e){return Array.from?Array.from(e):Array.prototype.slice.call(e,0)},a.isObject=function(e){return"[object Object]"===d.call(e)},a.fn=a.prototype={constructor:a,eq:function(e){if("number"==typeof e){var t=this[e];return a.fn.init(t)}return this},first:function(){return a.fn.eq.call(this,0)},last:function(){var e=this.length-1;return a.fn.eq.call(this,e)},append:function(e){var t=document.createDocumentFragment();return e instanceof a||/^\[object (NodeList|HTMLCollection)]$/.test(d.call(e))?this.last()[0]&&(m.slice.call(e).forEach(function(e){t.appendChild(e)}),this.last()[0].appendChild(t)):"string"==typeof e?this.each(function(t){t.appendChild(document.createTextNode(e))}):1!==e.nodeType&&11!==e.nodeType||this.last()[0]&&this.last()[0].appendChild(e),t=null,this},attr:function(e,t){if(a.isObject(e))this.each(function(t){for(var n in e)if(e.hasOwnProperty(n))try{t.setAttribute(n,e[n])}catch(i){}});else if("string"==typeof e&&(e=a.trim(e))){if(arguments.length<=1){var n=this.first()[0];return n?n.getAttribute(e):null}this.each(function(n){n.setAttribute(e,t+"")})}return this},prop:function(e,t){if(a.isObject(e))this.each(function(t){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])});else if("string"==typeof e&&(e=a.trim(e))){if(arguments.length<=1){var n=this.first()[0];return n?n[e]:null}this.each(function(n){n[e]=t})}return this},css:function(e,t){if(a.isObject(e))this.each(function(t){for(var n in e)e.hasOwnProperty(n)&&(t.style[n]=e[n])});else if("string"==typeof e&&(e=a.trim(e))){if(1===arguments.length){var n=this.first()[0];return a.css(n,e)}arguments.length>=2&&this.each(function(n){n.style[e]=t})}return this},each:function(e){var t=this.length;if(t>0&&"function"==typeof e){var n,i=0;for(i;i<t;i++)n=this[i],e.call(n,n,i)}return this},on:function(n,r,o,s){var c=this;if(null==o&&(o=r,r=void 0),!o)return this;o.hasOwnProperty("guid")||(o.guid=++l);var f=a.trim(n).split(/\s+/);return f.length>0&&this.each(function(n){var l=e(n);f.forEach(function(e){u[e]=u[e]||[];var f=t(n,e);0===f.length&&n.addEventListener(e,i,!1);var h={guid:l,type:e,handler:o,selector:r,elem:n};1===s&&(h.handler=function(e){a.fn.off.call(c,e.type,r,h.handler),o.apply(n,arguments)},h.handler.guid=o.guid),u[e].push(h)})}),this},one:function(e,t,n){return a.fn.on.call(this,e,t,n,1),this},off:function(e,n,r){if(null==r&&(r=n,n=void 0),""===a.trim(e))this.each(function(e){var t=e[c];if(t)for(var n in u)u[n]=u[n].filter(function(e){return e.guid!==t}),e.removeEventListener(n,i,!1)});else{var o=a.trim(e).split(/\s+/);this.each(function(e){var a=e[c];void 0!==a&&o.forEach(function(o){var s=u[o];s&&(r?u[o]=s.filter(function(e){return e.guid!==a||e.selector!==n||e.handler.guid!==r.guid}):u[o]=s.filter(function(e){return e.guid!==a||e.selector!==n}),0===t(e,o).length&&e.removeEventListener(o,i,!1))})})}return this},trigger:function(e,t){t=t||{bubbles:!0,cancelable:!0,detail:null};var i=n(e,t);return this.each(function(e){i.forEach(function(t){e.dispatchEvent(t)})}),this},addClass:function(e){return"string"==typeof e&&(e=a.trim(e))&&(e=e.split(/\s+/),this.each(function(t){var n=t.className.split(/\s+/);e.forEach(function(e){-1===n.indexOf(e)&&n.push(e)}),t.className=n.join(" ")})),this},removeClass:function(e){return"string"==typeof e&&(e=a.trim(e))&&(e=e.split(/\s+/),this.each(function(t){var n=t.className.split(/\s+/);e.forEach(function(e){var t=n.indexOf(e);-1!==t&&n.splice(t,1)}),t.className=n.join(" ")})),this},hasClass:function(e){if("string"==typeof e&&(e=a.trim(e))&&this.length>0){e=e.split(/\s+/);for(var t=!0,n=0;n<this.length;n++){var i=this[n];if(t=e.every(function(e){return-1!==i.className.split(/\s+/).indexOf(e)}),!t)return!1}return t}return!1},show:function(){return r(this,1),this},hide:function(){return r(this),this},html:function(e){if(!(arguments.length>0)){var t=this.first()[0];return t?t.innerHTML:""}return this.each(function(t){t.innerHTML=e+""}),this},text:function(e){if(!(arguments.length>0)){var t=this.first()[0];return t?t.textContent:""}return this.each(function(t){t.textContent=e+""}),this},empty:function(){return this.each(function(e){if(e.childNodes){var t=e.childNodes;t=a.arrayFrom(t),t.forEach(function(t){e.removeChild(t)})}}),this},remove:function(){return this.each(function(e){e.parentNode&&(a(e).off(),e.parentNode.removeChild(e))}),this},find:function(e){this.selector=e;var t=[];return this.each(function(n){try{var i=n.querySelectorAll(e);i=a.arrayFrom(i),t=t.concat(i)}catch(r){}}),a(t)}},a.fn.init=function(e){var t=this;if(null==e)return t;if(1===e.nodeType)return t[0]=e,t.selector="",t.length=1,t;if(/^\[object (NodeList|HTMLCollection)]$/.test(d.call(e))){var n=a.arrayFrom(e).filter(function(e){return 1===e.nodeType});return n.length>0&&(n.forEach(function(e,n){t[n]=e}),t.selector="",t.length=n.length),t}if(11===e.nodeType){var i=a.arrayFrom(e.children);return i.length>0&&(i.forEach(function(e,n){t[n]=e}),t.selector="",t.length=i.length),t}if(e===window||e===document)return t[0]=e,t.selector="",t.length=1,t;if("string"==typeof e&&(e=a.trim(e))){var r,o;try{r=document.querySelectorAll(e),o=r.length}catch(s){}if(o>0){for(var c=0;c<o;c++)t[c]=r[c];t.selector=e,t.length=o}}else a.isArray(e)&&(e=e.filter(function(e){return 1===e.nodeType}),e.forEach(function(e,n){t[n]=e}),t.length=e.length);return t},a.fn.init.prototype=a.fn,a});